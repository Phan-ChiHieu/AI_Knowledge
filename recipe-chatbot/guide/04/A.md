## T·ªëi ∆∞u SYSTEM_PROMPT ·ªü file: backend/utils.py

```python
# custom
SYSTEM_PROMPT: Final[str] = (
    "You are a friendly and creative culinary assistant. Your role is to help users find, understand, and execute recipes that are easy to follow, practical, and enjoyable.\n\n"
    "Always:\n"
    "- Provide an enticing title as a Level 2 Markdown heading (## Title of Recipe).\n"
    "- Follow with a 1-3 sentence engaging description.\n"
    "- Use Markdown formatting throughout your response.\n"
    "- Include three sections in order:\n"
    "    1. ### Ingredients ‚Äî Use bullet points (*).\n"
    "    2. ### Instructions ‚Äî Use numbered steps (1., 2., 3., ...).\n"
    "    3. Optional: Add ### Tips, ### Variations, or ### Notes if relevant.\n\n"
    "Never:\n"
    "- Recommend ingredients that are rare, expensive, or hard to find unless you give accessible alternatives.\n"
    "- Use offensive, derogatory, or culturally insensitive language.\n"
    "- Suggest unsafe, unethical, or harmful recipes. Politely decline if the request is inappropriate.\n\n"
    "Creativity:\n"
    "- You may suggest common variations or substitutions.\n"
    "- If no exact recipe exists, you may creatively combine known recipes, but clearly say so.\n"
    "- Feel free to invent new recipes ‚Äî just make sure to flag them as original creations.\n\n"
    "Your tone should be friendly, concise, and informative. Responses must be structured, well-formatted, and helpful to home cooks of all skill levels."
)
```

## Th√™m 10 c√¢u h·ªèi m·∫´u v√†o file: data/sample_queries.csv

```bash
id,query
1,Give me a quick Italian pasta recipe for dinner
2,What's a healthy vegan dessert I can make at home?
3,Can you suggest a gluten-free breakfast that's not boring?
4,I have chicken, rice, and broccoli ‚Äî what can I make?
5,I need a simple lunch idea for work that I can pack easily
6,Show me a dinner recipe that takes under 20 minutes
7,How do I bake something easy with no prior baking skills?
8,Can you give me a spicy Thai curry recipe?
9,I want a snack idea for kids that is both healthy and fun
10,What can I cook with just eggs and tomatoes?

```

---

---

## T·∫°o file: scripts/bulk_test.py

## I.

```python
from __future__ import annotations


import sys
from pathlib import Path

# Add project root to sys.path to allow a_s_b_absolute imports
PROJECT_ROOT = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

"""Bulk testing utility for the recipe chatbot agent.

Reads a CSV file containing user queries, fires them against the /chat
endpoint concurrently, and stores the results for later manual evaluation.
"""
```

Gi·∫£i th√≠ch r√µ r√†ng t·ª´ng ph·∫ßn ƒëo·∫°n code b·∫°n ƒë∆∞a:

### ‚úÖ 1. `from __future__ import annotations`

- **M·ª•c ƒë√≠ch**: Cho ph√©p _lazy evaluation_ c·ªßa ki·ªÉu d·ªØ li·ªáu (type annotations).
- **L·ª£i √≠ch**:

  - Gi√∫p b·∫°n c√≥ th·ªÉ d√πng ki·ªÉu tr·∫£ v·ªÅ trong h√†m m√† ch∆∞a c·∫ßn ƒë·ªãnh nghƒ©a class/type ƒë√≥ tr∆∞·ªõc.
  - Tr√°nh l·ªói ki·ªÉu v√≤ng l·∫∑p ho·∫∑c forward reference.

- **D√πng ph·ªï bi·∫øn t·ª´ Python 3.7+**, nh∆∞ng Python 3.10 tr·ªü ƒëi th√¨ g·∫ßn nh∆∞ m·∫∑c ƒë·ªãnh kh√¥ng c·∫ßn n·ªØa.

### ‚úÖ 2. `import sys`

- D√πng ƒë·ªÉ thao t√°c v·ªõi **Python runtime**: qu·∫£n l√Ω path, stdout, argv, v.v.
- ·ªû ƒë√¢y d√πng ƒë·ªÉ **ch·ªânh s·ª≠a `sys.path`** ‚Äî danh s√°ch c√°c th∆∞ m·ª•c m√† Python d√πng ƒë·ªÉ t√¨m module khi `import`.

### ‚úÖ 3. `from pathlib import Path`

- `Path` l√† class trong th∆∞ vi·ªán `pathlib` ‚Äî gi√∫p thao t√°c v·ªõi ƒë∆∞·ªùng d·∫´n file **d·ªÖ h∆°n** v√† **ƒëa n·ªÅn t·∫£ng**.
- Thay v√¨ d√πng string x·ª≠ l√Ω th·ªß c√¥ng (`os.path.join`, `os.path.abspath`,...), d√πng `Path` r√µ r√†ng v√† g·ªçn h∆°n.

### ‚úÖ 4. Th√™m th∆∞ m·ª•c g·ªëc v√†o `sys.path`

```python
PROJECT_ROOT = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(PROJECT_ROOT))
```

Gi·∫£i th√≠ch:

- `__file__`: l√† ƒë∆∞·ªùng d·∫´n file Python hi·ªán t·∫°i (file ƒëang ch·∫°y).
- `.resolve()` ‚Üí chuy·ªÉn ƒë∆∞·ªùng d·∫´n sang **tuy·ªát ƒë·ªëi** (absolute path).
- `.parent.parent` ‚Üí l·∫•y th∆∞ m·ª•c **g·ªëc c·ªßa project** (2 c·∫•p tr√™n).
- `sys.path.insert(0, ...)` ‚Üí th√™m ƒë∆∞·ªùng d·∫´n n√†y v√†o ƒë·∫ßu `sys.path`.

> ‚úÖ Vi·ªác n√†y gi√∫p c√°c import ki·ªÉu **absolute** (d√πng t·ª´ g·ªëc repo) ch·∫°y ƒë∆∞·ª£c, d√π b·∫°n ƒëang ·ªü b·∫•t k·ª≥ th∆∞ m·ª•c n√†o.

### ‚úÖ 5. Docstring (m√¥ t·∫£ file)

```python
"""Bulk testing utility for the recipe chatbot agent.

Reads a CSV file containing user queries, fires them against the `/chat`
endpoint concurrently, and stores the results for later manual evaluation.
"""
```

- ƒê√¢y l√† **docstring c·∫•p module** (m√¥ t·∫£ ch·ª©c nƒÉng c·ªßa file n√†y).
- M·ª•c ƒë√≠ch:

  - File n√†y l√† m·ªôt **utility ƒë·ªÉ test h√†ng lo·∫°t (bulk test)** chatbot.
  - N√≥:

    - ƒê·ªçc file `.csv` ch·ª©a c√°c c√¢u h·ªèi ng∆∞·ªùi d√πng
    - G·ª≠i y√™u c·∫ßu song song ƒë·∫øn endpoint `/chat`
    - Ghi l·∫°i k·∫øt qu·∫£ ƒë·ªÉ ƒë√°nh gi√° sau

### üìå T√≥m g·ªçn

| Th√†nh ph·∫ßn                               | Gi·∫£i th√≠ch                                                        |
| ---------------------------------------- | ----------------------------------------------------------------- |
| `from __future__ import annotations`     | Tr√¨ ho√£n vi·ªác ƒë√°nh gi√° type annotation ƒë·ªÉ tr√°nh l·ªói               |
| `sys.path.insert(...)`                   | Cho ph√©p import module t·ª´ th∆∞ m·ª•c g·ªëc project                     |
| `Path(__file__).resolve().parent.parent` | T√¨m ƒë∆∞·ªùng d·∫´n th∆∞ m·ª•c g·ªëc c·ªßa project                             |
| Docstring                                | M√¥ t·∫£ ch·ª©c nƒÉng: test h√†ng lo·∫°t endpoint `/chat` b·∫±ng d·ªØ li·ªáu CSV |

## II.

```python
# ...
#  Ti·∫øp theo
import argparse
import csv
import datetime as dt
from typing import List, Tuple, Dict
from concurrent.futures import ThreadPoolExecutor, as_completed

from rich.console import Console, Group
from rich.panel import Panel
from rich.text import Text
from rich.markdown import Markdown

from backend.utils import get_agent_response, SYSTEM_PROMPT
```

### ‚úÖ 1. **Th∆∞ vi·ªán chu·∫©n c·ªßa Python**

```python
import argparse
import csv
import datetime as dt
from typing import List, Tuple, Dict
from concurrent.futures import ThreadPoolExecutor, as_completed
```

#### `argparse`

- D√πng ƒë·ªÉ **ƒë·ªãnh nghƒ©a v√† ph√¢n t√≠ch c√°c tham s·ªë d√≤ng l·ªánh** (CLI).
- V√≠ d·ª•: khi ch·∫°y `python bulk_test.py --input data.csv`, n√≥ s·∫Ω x·ª≠ l√Ω `--input`.

#### `csv`

- D√πng ƒë·ªÉ ƒë·ªçc/ghi file CSV ch·ª©a c√°c c√¢u h·ªèi ng∆∞·ªùi d√πng (`sample_queries.csv`) v√† l∆∞u k·∫øt qu·∫£ test.

#### `datetime as dt`

- D√πng ƒë·ªÉ l·∫•y timestamp, v√≠ d·ª•: g·∫Øn ng√†y gi·ªù cho file k·∫øt qu·∫£.
- Vi·∫øt t·∫Øt `as dt` ƒë·ªÉ sau n√†y g·ªçi `dt.datetime.now()` cho g·ªçn.

#### `typing` (`List`, `Tuple`, `Dict`)

- D√πng ƒë·ªÉ khai b√°o ki·ªÉu cho h√†m ho·∫∑c bi·∫øn, gi√∫p code d·ªÖ ƒë·ªçc, d·ªÖ b·∫£o tr√¨.

#### `concurrent.futures.ThreadPoolExecutor, as_completed`

- Cho ph√©p **th·ª±c thi song song nhi·ªÅu t√°c v·ª• b·∫±ng ƒëa lu·ªìng** (multi-threading).
- ·ªû ƒë√¢y d√πng ƒë·ªÉ g·ª≠i nhi·ªÅu request ƒë·∫øn `/chat` **ƒë·ªìng th·ªùi** => tƒÉng t·ªëc bulk test.

### ‚úÖ 2. **Th∆∞ vi·ªán Rich (hi·ªÉn th·ªã k·∫øt qu·∫£ ƒë·∫πp h∆°n)**

```python
from rich.console import Console, Group
from rich.panel import Panel
from rich.text import Text
from rich.markdown import Markdown
```

ƒê√¢y l√† c√°c class t·ª´ th∆∞ vi·ªán [`rich`](https://github.com/Textualize/rich) ‚Äî gi√∫p in ra terminal **ƒë·∫πp, c√≥ m√†u, d·ªÖ ƒë·ªçc**:

| Th√†nh ph·∫ßn | T√°c d·ª•ng                                |
| ---------- | --------------------------------------- |
| `Console`  | D√πng ƒë·ªÉ in ra console thay v√¨ `print()` |
| `Group`    | Gom nhi·ªÅu th√†nh ph·∫ßn hi·ªÉn th·ªã l·∫°i       |
| `Panel`    | T·∫°o khung vi·ªÅn quanh n·ªôi dung           |
| `Text`     | In vƒÉn b·∫£n c√≥ format m√†u, in ƒë·∫≠m, v.v.  |
| `Markdown` | Hi·ªÉn th·ªã n·ªôi dung Markdown ƒë√∫ng format  |

‚Üí D√πng ƒë·ªÉ **hi·ªÉn th·ªã k·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ bot r√µ r√†ng**, v√≠ d·ª•: t√¥ ƒë·∫≠m c√¢u h·ªèi, hi·ªán Markdown cho d·ªÖ xem.

### ‚úÖ 3. **Import n·ªôi b·ªô project**

```python
from backend.utils import get_agent_response, SYSTEM_PROMPT
```

- `get_agent_response`: l√† h√†m ch√≠nh ƒë·ªÉ g·ª≠i request ƒë·∫øn chatbot v√† l·∫•y k·∫øt qu·∫£ tr·∫£ v·ªÅ.
- `SYSTEM_PROMPT`: l√† prompt h·ªá th·ªëng ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a tr∆∞·ªõc, d√πng ƒë·ªÉ ƒë·∫£m b·∫£o bot ph·∫£n h·ªìi ƒë√∫ng vai tr√≤.

### üìå T·ªïng k·∫øt l·∫°i:

| Nh√≥m                          | M·ª•c ƒë√≠ch ch√≠nh                          |
| ----------------------------- | --------------------------------------- |
| `argparse`, `csv`, `datetime` | Qu·∫£n l√Ω input/output v√† th·ªùi gian       |
| `typing`                      | G·ª£i √Ω ki·ªÉu d·ªØ li·ªáu cho code r√µ r√†ng h∆°n |
| `ThreadPoolExecutor`          | G·ª≠i nhi·ªÅu request ƒë·ªìng th·ªùi             |
| `rich`                        | Hi·ªÉn th·ªã k·∫øt qu·∫£ ƒë·∫πp trong terminal     |
| `backend.utils`               | G·ªçi bot v√† d√πng system prompt ƒë√£ setup  |

## III.

```python
# -----------------------------------------------------------------------------
# Configuration helpers
# -----------------------------------------------------------------------------

DEFAULT_CSV: Path = Path("data/sample_queries.csv")
RESULTS_DIR: Path = Path("results")
RESULTS_DIR.mkdir(exist_ok=True)

MAX_WORKERS = 32 # For ThreadPoolExecutor
```

### ‚úÖ 1. **`DEFAULT_CSV`**

```python
DEFAULT_CSV: Path = Path("data/sample_queries.csv")
```

- ƒê√¢y l√† ƒë∆∞·ªùng d·∫´n m·∫∑c ƒë·ªãnh t·ªõi file CSV ch·ª©a c√°c c√¢u h·ªèi ng∆∞·ªùi d√πng.
- S·ª≠ d·ª•ng `Path(...)` ƒë·ªÉ l√†m vi·ªác v·ªõi file path m·ªôt c√°ch **an to√†n v√† ƒëa n·ªÅn t·∫£ng**.

> N·∫øu khi ch·∫°y script m√† **kh√¥ng ch·ªâ ƒë·ªãnh file input**, th√¨ n√≥ s·∫Ω d√πng `DEFAULT_CSV`.

### ‚úÖ 2. **`RESULTS_DIR`**

```python
RESULTS_DIR: Path = Path("results")
RESULTS_DIR.mkdir(exist_ok=True)
```

- T·∫°o th∆∞ m·ª•c `results/` ƒë·ªÉ ch·ª©a k·∫øt qu·∫£ c·ªßa c√°c l·∫ßn bulk test.
- `mkdir(exist_ok=True)` s·∫Ω:

  - **T·∫°o th∆∞ m·ª•c n·∫øu ch∆∞a c√≥**
  - **Kh√¥ng g√¢y l·ªói** n·∫øu th∆∞ m·ª•c ƒë√£ t·ªìn t·∫°i

‚Üí ƒê·∫£m b·∫£o th∆∞ m·ª•c l∆∞u k·∫øt qu·∫£ lu√¥n s·∫µn s√†ng.

### ‚úÖ 3. **`MAX_WORKERS`**

```python
MAX_WORKERS = 32
```

- ƒê√¢y l√† s·ªë **thread t·ªëi ƒëa** khi d√πng `ThreadPoolExecutor` ƒë·ªÉ ch·∫°y song song.
- M·ªói thread s·∫Ω g·ª≠i m·ªôt request t·ªõi chatbot endpoint `/chat`.

> C√†ng nhi·ªÅu thread ‚Üí c√†ng nhi·ªÅu c√¢u h·ªèi ƒë∆∞·ª£c x·ª≠ l√Ω c√πng l√∫c ‚Üí nhanh h∆°n.
> Nh∆∞ng n·∫øu server gi·ªõi h·∫°n rate ho·∫∑c kh√¥ng scale t·ªët ‚Üí d·ªÖ timeout ho·∫∑c l·ªói 429.

### üìå T√≥m g·ªçn:

| Bi·∫øn          | M·ª•c ƒë√≠ch                                  |
| ------------- | ----------------------------------------- |
| `DEFAULT_CSV` | ƒê∆∞·ªùng d·∫´n m·∫∑c ƒë·ªãnh ƒë·∫øn file c√¢u h·ªèi       |
| `RESULTS_DIR` | Th∆∞ m·ª•c ƒë·ªÉ l∆∞u k·∫øt qu·∫£ test               |
| `MAX_WORKERS` | S·ªë thread t·ªëi ƒëa ƒë·ªÉ g·ª≠i request ƒë·ªìng th·ªùi |

## IV.

```python
# -----------------------------------------------------------------------------
# Core logic
# -----------------------------------------------------------------------------

# --- Sync function for ThreadPoolExecutor ---
def process_query_sync(query_id: str, query: str) -> Tuple[str, str, str]:
    """Processes a single query by calling the agent directly."""
    initial_messages: List[Dict[str, str]] = [
        {"role": "user", "content": query}
    ]
    try:
        # get_agent_response now returns the full history
        updated_history = get_agent_response(initial_messages)
        # Extract the last assistant message for the result
        assistant_reply = ""
        if updated_history and updated_history[-1]["role"] == "assistant":
            assistant_reply = updated_history[-1]["content"]
        else: # Should not happen with current logic but good to handle
            assistant_reply = "Error: No assistant reply found in history."
        return query_id, query, assistant_reply
    except Exception as e:
        return query_id, query, f"Error processing query: {str(e)}"

```

## ‚úÖ H√†m `process_query_sync()`

```python
def process_query_sync(query_id: str, query: str) -> Tuple[str, str, str]:
```

- H√†m n√†y nh·∫≠n v√†o:

  - `query_id`: ID c·ªßa c√¢u h·ªèi (ƒë·ªÉ trace l·∫°i khi ghi file)
  - `query`: n·ªôi dung c√¢u h·ªèi t·ª´ ng∆∞·ªùi d√πng

- Tr·∫£ v·ªÅ tuple: `(query_id, query, assistant_reply)`

  - T·ª©c l√† tr·∫£ l·∫°i k·∫øt qu·∫£ chatbot tr·∫£ l·ªùi cho c√¢u h·ªèi ƒë√≥.

### ‚úÖ T·∫°o ƒëo·∫°n h·ªôi tho·∫°i ban ƒë·∫ßu

```python
initial_messages: List[Dict[str, str]] = [
    {"role": "user", "content": query}
]
```

- T·∫°o m·ªôt "history" ng·∫Øn g·ªìm 1 message duy nh·∫•t: t·ª´ **user** v·ªõi n·ªôi dung c√¢u h·ªèi.
- ƒê√¢y l√† format chu·∫©n ƒë·ªÉ g·ª≠i ƒë·∫øn `get_agent_response()` ‚Äî theo ki·ªÉu c·ªßa OpenAI API (`[{ role, content }]`).

### ‚úÖ G·ªçi chatbot ƒë·ªÉ l·∫•y ph·∫£n h·ªìi

```python
updated_history = get_agent_response(initial_messages)
```

- H√†m `get_agent_response()` s·∫Ω:

  - G·ª≠i `initial_messages` ƒë·∫øn agent
  - Nh·∫≠n l·∫°i to√†n b·ªô l·ªãch s·ª≠ ƒë·ªëi tho·∫°i (g·ªìm c·∫£ c√¢u tr·∫£ l·ªùi)

### ‚úÖ Tr√≠ch xu·∫•t ph·∫£n h·ªìi cu·ªëi c·ªßa bot

```python
assistant_reply = ""
if updated_history and updated_history[-1]["role"] == "assistant":
    assistant_reply = updated_history[-1]["content"]
else:
    assistant_reply = "Error: No assistant reply found in history."
```

- Ki·ªÉm tra:

  - N·∫øu c√≥ ph·∫£n h·ªìi v√† d√≤ng cu·ªëi c√πng trong l·ªãch s·ª≠ l√† t·ª´ `assistant`
    ‚Üí l·∫•y n·ªôi dung tr·∫£ l·ªùi (`content`)
  - N·∫øu kh√¥ng (l·ªói, format b·∫•t th∆∞·ªùng) ‚Üí tr·∫£ v·ªÅ th√¥ng b√°o l·ªói ƒë∆°n gi·∫£n.

> ‚úÖ Gi√∫p ch∆∞∆°ng tr√¨nh **kh√¥ng b·ªã crash** n·∫øu bot kh√¥ng ph·∫£n h·ªìi ƒë√∫ng format.

### ‚úÖ B·∫Øt l·ªói to√†n c·ª•c

```python
except Exception as e:
    return query_id, query, f"Error processing query: {str(e)}"
```

- N·∫øu b·∫•t k·ª≥ l·ªói g√¨ x·∫£y ra khi g·ªçi API (timeout, m·∫°ng, format l·ªói...) th√¨ b·∫Øt exception v√† tr·∫£ v·ªÅ th√¥ng b√°o l·ªói.
- Tr√°nh cho ch∆∞∆°ng tr√¨nh ch·∫øt gi·ªØa ch·ª´ng.

## üìå T√≥m t·∫Øt

| Th√†nh ph·∫ßn                             | Gi·∫£i th√≠ch                                        |
| -------------------------------------- | ------------------------------------------------- |
| `initial_messages`                     | Tin nh·∫Øn kh·ªüi ƒë·∫ßu g·ª≠i cho chatbot                 |
| `get_agent_response(...)`              | G·ªçi agent ƒë·ªÉ nh·∫≠n ph·∫£n h·ªìi                        |
| Ki·ªÉm tra `[-1]["role"] == "assistant"` | ƒê·∫£m b·∫£o c√≥ ph·∫£n h·ªìi ƒë√∫ng ƒë·ªãnh d·∫°ng                |
| `try/except`                           | Gi√∫p x·ª≠ l√Ω an to√†n, kh√¥ng l√†m s·∫≠p lu·ªìng bulk test |

## ‚úÖ V√¨ sao c·∫ßn vi·∫øt t√°ch ra nh∆∞ v·∫≠y?

- H√†m n√†y d√πng trong `ThreadPoolExecutor`, n√™n:

  - Ph·∫£i **ƒë·ªôc l·∫≠p**, t·ª± x·ª≠ l√Ω l·ªói ri√™ng.
  - Nh·∫≠n ƒë·∫ßu v√†o ƒë∆°n gi·∫£n, tr·∫£ v·ªÅ r√µ r√†ng.

- D·ªÖ d√†ng ch·∫°y h√†ng trƒÉm truy v·∫•n song song m√† kh√¥ng ·∫£nh h∆∞·ªüng nhau n·∫øu l·ªói x·∫£y ra.

## V.

```python
# Renamed and made sync
def run_bulk_test(csv_path: Path, num_workers: int = MAX_WORKERS) -> None:
    """Main entry point for bulk testing (synchronous version)."""

    with csv_path.open("r", newline="", encoding="utf-8") as csv_file:
        reader = csv.DictReader(csv_file)
        # Expects columns 'id' and 'query'
        input_data: List[Dict[str, str]] = [
            row for row in reader if row.get("id") and row.get("query")
        ]

    if not input_data:
        raise ValueError("No valid data (with 'id' and 'query') found in the provided CSV file.")

    console = Console()
    results_data: List[Tuple[str, str, str]] = [] # Will store (id, query, response)
    with ThreadPoolExecutor(max_workers=num_workers) as executor:
        future_to_data = {
            executor.submit(process_query_sync, item["id"], item["query"]):
            item for item in input_data
        }
        console.print(f"[bold blue]Submitting {len(input_data)} queries to the executor...[/bold blue]")
        for i, future in enumerate(as_completed(future_to_data)):
            item_data = future_to_data[future]
            item_id = item_data["id"]
            item_query = item_data["query"]
            try:
                processed_id, original_query, response_text = future.result()
                results_data.append((processed_id, original_query, response_text))

                panel_content = Text()
                panel_content.append(f"ID: {processed_id}\n", style="bold magenta")
                panel_content.append("Query:\n", style="bold yellow")
                panel_content.append(f"{original_query}\n\n")

                # Create a separate Markdown object for the response
                response_markdown = Markdown(response_text)

                # Group the different parts for the Panel
                panel_group = Group(
                    panel_content, # Contains ID and Query
                    Markdown("--- Response ---"), # A small separator for clarity
                    response_markdown  # The Markdown rendered response
                )

                console.print(Panel(
                    panel_group, # Pass the group as the single renderable
                    title=f"Result {i+1}/{len(input_data)} - ID: {processed_id}",
                    border_style="cyan"
                ))

            except Exception as exc:
                console.print(Panel(f"[bold red]Exception for ID {item_id}, Query:[/bold red]\n{item_query}\n\n[bold red]Error:[/bold red]\n{exc}", title=f"Error in Result {i+1}/{len(input_data)} - ID: {item_id}", border_style="red"))
                results_data.append((item_id, item_query, f"Exception during processing: {str(exc)}"))
        console.print("[bold blue]All queries processed.[/bold blue]")

    timestamp = dt.datetime.now().strftime("%Y%m%d_%H%M%S")
    out_path = RESULTS_DIR / f"results_{timestamp}.csv"

    with out_path.open("w", newline="", encoding="utf-8") as csv_file:
        writer = csv.writer(csv_file)
        writer.writerow(["id", "query", "response"])
        writer.writerows(results_data)

    console.print(f"[bold green]Saved {len(results_data)} results to {str(out_path)}[/bold green]")


```

H√†m `run_bulk_test(...)` l√† **tr√°i tim c·ªßa to√†n b·ªô bulk test tool** ‚Äî n√≥ ƒë·ªçc d·ªØ li·ªáu, x·ª≠ l√Ω song song, in ra k·∫øt qu·∫£ r√µ r√†ng, v√† l∆∞u k·∫øt qu·∫£ xu·ªëng file CSV.

D∆∞·ªõi ƒë√¢y l√† **ph√¢n t√≠ch chi ti·∫øt t·ª´ng kh·ªëi**, gi√∫p b·∫°n hi·ªÉu s√¢u t·ª´ng d√≤ng:

## ‚úÖ ƒê·ªãnh nghƒ©a h√†m

```python
def run_bulk_test(csv_path: Path, num_workers: int = MAX_WORKERS) -> None:
    """Main entry point for bulk testing (synchronous version)."""
```

- `csv_path`: ƒë∆∞·ªùng d·∫´n t·ªõi file CSV ch·ª©a c√¢u h·ªèi.
- `num_workers`: s·ªë lu·ªìng x·ª≠ l√Ω song song (m·∫∑c ƒë·ªãnh l√† 32).
- Tr·∫£ v·ªÅ `None`, v√¨ t√°c d·ª•ng ch√≠nh l√† **in k·∫øt qu·∫£ v√† ghi file**.

## ‚úÖ ƒê·ªçc v√† parse file CSV

```python
with csv_path.open("r", newline="", encoding="utf-8") as csv_file:
    reader = csv.DictReader(csv_file)
    input_data = [row for row in reader if row.get("id") and row.get("query")]
```

- M·ªü file CSV, d√πng `DictReader` ƒë·ªÉ ƒë·ªçc t·ª´ng d√≤ng th√†nh dict (`{"id": ..., "query": ...}`).
- B·ªè qua c√°c d√≤ng thi·∫øu c·ªôt `id` ho·∫∑c `query`.
- `input_data` l√† danh s√°ch c√°c c√¢u h·ªèi h·ª£p l·ªá.

## ‚úÖ Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o

```python
if not input_data:
    raise ValueError("No valid data (with 'id' and 'query') found in the provided CSV file.")
```

- N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá, d·ª´ng ngay v·ªõi l·ªói r√µ r√†ng.
- Tr√°nh ch·∫°y v√¥ nghƒ©a ho·∫∑c l·ªói ng·∫ßm sau n√†y.

## ‚úÖ Kh·ªüi t·∫°o console Rich & k·∫øt qu·∫£ r·ªóng

```python
console = Console()
results_data: List[Tuple[str, str, str]] = []
```

- `Console()` d√πng ƒë·ªÉ in ra ƒë·∫πp.
- `results_data` s·∫Ω ch·ª©a `(id, query, response)` ƒë·ªÉ ghi file sau.

## ‚úÖ Ch·∫°y song song v·ªõi ThreadPoolExecutor

```python
with ThreadPoolExecutor(max_workers=num_workers) as executor:
    future_to_data = {
        executor.submit(process_query_sync, item["id"], item["query"]): item
        for item in input_data
    }
```

- Kh·ªüi t·∫°o `ThreadPoolExecutor` ƒë·ªÉ x·ª≠ l√Ω ƒë·ªìng th·ªùi c√°c query.
- `executor.submit(...)` t·∫°o ra `Future` object ‚Äî k·∫øt qu·∫£ s·∫Ω c√≥ sau.
- `future_to_data` l√† dict map `Future` ‚Üí `item` ƒë·ªÉ bi·∫øt k·∫øt qu·∫£ n√†o thu·ªôc c√¢u h·ªèi n√†o.

## ‚úÖ Duy·ªát t·ª´ng k·∫øt qu·∫£ khi ho√†n t·∫•t

```python
for i, future in enumerate(as_completed(future_to_data)):
```

- `as_completed(...)` s·∫Ω yield t·ª´ng `future` ngay khi n√≥ xong, **kh√¥ng theo th·ª© t·ª± g·ªëc**.
- M·ªói l·∫ßn l·∫∑p, b·∫°n x·ª≠ l√Ω k·∫øt qu·∫£ c·ªßa m·ªôt c√¢u h·ªèi.

## ‚úÖ X·ª≠ l√Ω k·∫øt qu·∫£ tr·∫£ v·ªÅ

```python
processed_id, original_query, response_text = future.result()
results_data.append((processed_id, original_query, response_text))
```

- L·∫•y k·∫øt qu·∫£ (ho·∫∑c l·ªói n·∫øu c√≥).
- L∆∞u v√†o `results_data` ƒë·ªÉ ghi file sau.

## ‚úÖ In ƒë·∫πp t·ª´ng k·∫øt qu·∫£ b·∫±ng Rich

```python
panel_content = Text()
panel_content.append(f"ID: {processed_id}\n", style="bold magenta")
panel_content.append("Query:\n", style="bold yellow")
panel_content.append(f"{original_query}\n\n")

response_markdown = Markdown(response_text)

panel_group = Group(
    panel_content,
    Markdown("---Response---"),
    response_markdown
)

console.print(Panel(
    panel_group,
    title=f"Result {i+1}/{len(input_data)} - ID: {processed_id}",
    border_style="cyan"
))
```

- In ra:

  - ID
  - Query
  - K·∫øt qu·∫£ tr·∫£ l·ªùi c·ªßa bot (render Markdown n·∫øu c√≥ format ƒë·∫πp)

- T·∫•t c·∫£ ƒë∆∞·ª£c bao b·ªüi `Panel` v√† c√≥ m√†u ‚Üí d·ªÖ xem h√†ng lo·∫°t.

## ‚úÖ B·∫Øt l·ªói khi c√≥ exception

```python
except Exception as exc:
    console.print(Panel(
        f"[bold red]Exception for ID {item_id}, Query:[/bold red]\n{item_query}\n\n[bold red]Error:[/bold red]\n{exc}",
        title=f"Error in Result {i+1}/{len(input_data)} - ID: {item_id}",
        border_style="red"
    ))
    results_data.append((item_id, item_query, f"Exception during processing: {str(exc)}"))
```

- N·∫øu `future.result()` n√©m l·ªói (VD: timeout, fail API), n√≥ s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü ƒë√¢y.
- In l·ªói ra m√†n h√¨nh k√®m th√¥ng tin truy v·∫•n b·ªã l·ªói.
- V·∫´n l∆∞u k·∫øt qu·∫£ l·ªói v√†o `results_data`.

## ‚úÖ In th√¥ng b√°o k·∫øt th√∫c

```python
console.print("[bold blue]All queries processed.[/bold blue]")
```

## ‚úÖ Ghi k·∫øt qu·∫£ ra file

```python
timestamp = dt.datetime.now().strftime("%Y%m%d_%H%M%S")
out_path = RESULTS_DIR / f"results_{timestamp}.csv"

with out_path.open("w", newline="", encoding="utf-8") as csv_file:
    writer = csv.writer(csv_file)
    writer.writerow(["id", "query", "response"])
    writer.writerows(results_data)
```

- T·∫°o t√™n file theo timestamp ƒë·ªÉ kh√¥ng b·ªã ƒë√® l√™n file c≈©.
- Ghi file CSV g·ªìm 3 c·ªôt: `id`, `query`, `response`.

## ‚úÖ In ra ƒë∆∞·ªùng d·∫´n file k·∫øt qu·∫£

```python
console.print(f"[bold green]Saved {len(results_data)} results to {str(out_path)}[/bold green]")
```

## ‚úÖ T·ªïng k·∫øt lu·ªìng ch·∫°y

1. ƒê·ªçc file CSV ƒë·∫ßu v√†o.
2. T·∫°o pool lu·ªìng ƒë·ªÉ g·ªçi `process_query_sync(...)` song song.
3. Khi m·ªói truy v·∫•n ho√†n th√†nh:

   - In k·∫øt qu·∫£ ra terminal (ƒë·∫πp, r√µ).
   - L∆∞u v√†o danh s√°ch k·∫øt qu·∫£.

4. Khi xong t·∫•t c·∫£:

   - Ghi ra file `results_<timestamp>.csv`.
   - In th√¥ng b√°o ho√†n th√†nh.

## VI.

```python
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Bulk test the recipe chatbot")
    parser.add_argument("--csv", type=Path, default=DEFAULT_CSV, help="Path to CSV file containing queries (column name: 'query').")
    parser.add_argument("--workers", type=int, default=MAX_WORKERS, help=f"Number of worker threads (default: {MAX_WORKERS}).")
    args = parser.parse_args()
    run_bulk_test(args.csv, args.workers)

```

ƒê√¢y l√† ph·∫ßn **entry point** c·ªßa ch∆∞∆°ng tr√¨nh ‚Äî ƒëo·∫°n m√£ cho ph√©p script n√†y c√≥ th·ªÉ ch·∫°y ƒë·ªôc l·∫≠p t·ª´ d√≤ng l·ªánh (`python script_name.py`). M√¨nh s·∫Ω gi·∫£i th√≠ch **k·ªπ l∆∞·ª°ng t·ª´ng d√≤ng**:

## ‚úÖ `if __name__ == "__main__":`

```python
if __name__ == "__main__":
```

- ƒê√¢y l√† ti√™u chu·∫©n ƒë·ªÉ Python ph√¢n bi·ªát gi·ªØa:

  - **Ch·∫°y tr·ª±c ti·∫øp file n√†y** (`python bulk_test.py`)
  - **Import file n√†y nh∆∞ m·ªôt module**

> Ch·ªâ khi **ch·∫°y tr·ª±c ti·∫øp**, kh·ªëi code n√†y m·ªõi th·ª±c thi.
> N·∫øu import t·ª´ file kh√°c, n√≥ s·∫Ω **kh√¥ng ch·∫°y**.

## ‚úÖ T·∫°o `argparse.ArgumentParser`

```python
parser = argparse.ArgumentParser(description="Bulk test the recipe chatbot")
```

- T·∫°o m·ªôt parser d√≤ng l·ªánh ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ truy·ªÅn tham s·ªë khi ch·∫°y script.
- `description` l√† n·ªôi dung m√¥ t·∫£ ‚Äî hi·ªán ra khi ch·∫°y `python bulk_test.py --help`.

## ‚úÖ Th√™m argument `--csv`

```python
parser.add_argument(
    "--csv",
    type=Path,
    default=DEFAULT_CSV,
    help="Path to CSV file containing queries (column name: 'query')."
)
```

- Cho ph√©p ng∆∞·ªùi d√πng **ch·ªâ ƒë·ªãnh file CSV** ch·ª©a c√¢u h·ªèi.
- N·∫øu kh√¥ng ch·ªâ ƒë·ªãnh, s·∫Ω d√πng m·∫∑c ƒë·ªãnh `data/sample_queries.csv`.
- Ki·ªÉu d·ªØ li·ªáu `Path` gi√∫p x·ª≠ l√Ω ƒë∆∞·ªùng d·∫´n chu·∫©n.

## ‚úÖ Th√™m argument `--workers`

```python
parser.add_argument(
    "--workers",
    type=int,
    default=MAX_WORKERS,
    help=f"Number of worker threads (default: {MAX_WORKERS})."
)
```

- Cho ph√©p ng∆∞·ªùi d√πng ch·ªânh s·ªë l∆∞·ª£ng thread x·ª≠ l√Ω ƒë·ªìng th·ªùi.
- M·∫∑c ƒë·ªãnh l√† `MAX_WORKERS = 32`.

## ‚úÖ Ph√¢n t√≠ch v√† ch·∫°y test

```python
args = parser.parse_args()
run_bulk_test(args.csv, args.workers)
```

- `parser.parse_args()` s·∫Ω ph√¢n t√≠ch c√°c tham s·ªë d√≤ng l·ªánh ng∆∞·ªùi d√πng truy·ªÅn v√†o.
- G·ªçi h√†m `run_bulk_test(...)` v·ªõi:

  - `args.csv`: ƒë∆∞·ªùng d·∫´n file CSV
  - `args.workers`: s·ªë thread ƒë·ªìng th·ªùi

## ‚úÖ V√≠ d·ª• s·ª≠ d·ª•ng

```bash
# D√πng file m·∫∑c ƒë·ªãnh + 32 workers
python bulk_test.py

# D√πng file c·ª• th·ªÉ + 10 workers
python bulk_test.py --csv data/my_queries.csv --workers 10
```

## ‚úÖ T·ªïng k·∫øt cu·ªëi c√πng

| M·ª•c                  | Gi·∫£i th√≠ch                        |
| -------------------- | --------------------------------- |
| `argparse`           | Cho ph√©p c·∫•u h√¨nh CLI linh ho·∫°t   |
| `--csv`              | ƒê∆∞·ªùng d·∫´n ƒë·∫øn file ch·ª©a c√¢u h·ªèi   |
| `--workers`          | S·ªë lu·ªìng x·ª≠ l√Ω ƒë·ªìng th·ªùi          |
| `run_bulk_test(...)` | G·ªçi h√†m ch√≠nh ƒë√£ ph√¢n t√≠ch ·ªü tr√™n |

N·∫øu b·∫°n c·∫ßn:

- In th√™m th·ªùi gian ch·∫°y t·ª´ng query
- Ghi log ra file
- H·ªó tr·ª£ `--output results.csv`
- ƒê·ªïi th√†nh async ƒë·ªÉ scale l·ªõn h∆°n

## VII.

```bash
python scripts/bulk_test.py
```

![Images Demo](../imgs/04/1.webp)
